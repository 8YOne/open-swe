# syntax=docker/dockerfile:1
FROM node:24-alpine AS deps
WORKDIR /app
COPY package.json yarn.lock .yarnrc.yml ./
COPY apps ./apps
COPY packages ./packages
RUN corepack enable && yarn install --immutable

FROM node:24-alpine AS builder
WORKDIR /app
COPY --from=deps /app /app
ENV NODE_ENV=production
RUN corepack enable \
 && yarn workspace @open-swe/web build

FROM node:24-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
EXPOSE 3000

# Copy only the built web app output and needed files
COPY --from=deps /app/package.json /app/yarn.lock /app/.yarnrc.yml ./
COPY --from=deps /app/apps/web/package.json ./apps/web/package.json
COPY --from=deps /app/packages ./packages
COPY --from=builder /app/apps/web/.next ./apps/web/.next
COPY --from=builder /app/apps/web/public ./apps/web/public

CMD ["yarn", "workspace", "@open-swe/web", "start"]


